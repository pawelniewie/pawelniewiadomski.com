<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <meta property="og:title" content="How to change source for Active Model?">

<meta property="og:type" content="website">

<meta property="og:url" content="https://pawelniewiadomski.com/2016/11/14/how-to-change-source-for-active-model/">

<meta property="og:image" content="https://pawelniewiadomski.com/media/avatar.jpg">

<meta property="og:description" content="">

<meta property="og:site_name" content="Pawel Niewiadomski">

<meta property="og:locale" content="en_US">


  <meta property="article:published_time" content="2016-11-14T00:00:00+00:00">
  <meta property="article:author" content="http://facebook.com/pawelniewie">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2017/02/27/graphql-intro-to-queries-mutations-authorization/">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2017/02/20/pitfalls-of-ruby-memoization-pattern/">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2016/12/06/is-unless-in-ruby-really-a-shortcut/">
  


<meta property="fb:admins" content="http://facebook.com/pawelniewie">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1934760-4', 'auto');
  ga('send', 'pageview');
</script>
<script src="/public/jquery.scrolldepth.min.js"></script>
<script src="/public/screentime.min.js"></script>
<script src="/public/riveted.min.js"></script>
<script>
jQuery(function() {
  jQuery.scrollDepth();
  jQuery.screentime({
	  fields: [
	    { selector: '.masthead',
	      name: 'Master header'
	    },
	    { selector: '.container .post',
	      name: 'Post'
	    },
	    { selector: '.container .related',
	      name: 'Related'
	    }
	  ],
    googleAnalytics: true
	});
  riveted.init();
});
</script>
<script src="/public/hotjar.min.js"></script>
<script>
jQuery(function() {
	jQuery('#mce-NAME').on('change', function() {
		ga('send', 'event', 'Newsletter', 'Filled', 'First name');
	});

	jQuery('#mce-EMAIL').on('change', function() {
		ga('send', 'event', 'Newsletter', 'Filled', 'Email');
	});

	jQuery('#mc-embedded-subscribe').on('click', function() {
		ga('send', 'event', 'Newsletter', 'Clicked', 'Subscribe');
	});
});
</script>

  <title>
    
      How to change source for Active Model? &middot; Pawel Niewiadomski
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="canonical" href="https://pawelniewiadomski.com/2016/11/14/how-to-change-source-for-active-model/">
</head>


  <body>
    <div class="container content">
  <small class="back">
    <strong>‚Üê <a href="https://pawelniewiadomski.com">back home</a></strong>
  </small>

  <article class="post">
    <h1 class="post-title">How to change source for Active Model?</h1>
    
      <span class="post-date">14 Nov 2016</span>
    
    <p>The nice thing about Active Record scopes is that you not only can specify where conditions. I recently had a need to run a query against a model to discover previous and next elements. This can be easily achieved using window functions. The query can looks something like:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="p">(</span><span class="k">select</span> <span class="o">*</span><span class="p">,</span> <span class="n">lag</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">position</span><span class="p">)</span> <span class="k">as</span> <span class="n">prev</span><span class="p">,</span> <span class="n">lead</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">position</span><span class="p">)</span> <span class="k">as</span> <span class="k">next</span> <span class="k">from</span> <span class="n">itinerary_flights</span><span class="p">;</span>
</code></pre></div>
<p>This query adds two additional columns that list ids of elements in order defined by <code>position</code> field.</p>

<p>I&#39;m not going to go into window function details. There&#39;s a lot of great tutorials about them already.</p>

<p>So I stumbled for a minute how to change <code>ItineraryFlight</code> model to use this select as a source so I could use all other goodies I had defined there.</p>

<p>I guess by reading the introduction you already guessed how it can be done.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">scope</span> <span class="ss">:with_previous_and_next_flights</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">itinerary_id</span><span class="p">)</span> <span class="p">{</span> <span class="n">from_previous_next_flights</span><span class="p">(</span><span class="n">itinerary_id</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div>
<p>In my case I wanted to get only one row with additional fields so I passed the <code>itinerary_id</code>. I had this methods defined as well:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_previous_next_flights</span><span class="p">(</span><span class="n">itinerary_id</span><span class="p">)</span>
    <span class="n">from</span> <span class="o">&lt;&lt;-</span><span class="dl">SQL</span><span class="o">.</span><span class="n">strip_heredoc</span>
<span class="sh">      (select *, lag(id) over(order by position) as prev, lead(id) over(order by position) as next from itinerary_flights where itinerary_id=#{itinerary_id.to_i}) AS itinerary_flights</span>
<span class="dl">    SQL</span>
<span class="k">end</span>
</code></pre></div>
<p>The trick here was to use <code>AS itinerary_flights</code> at the end to match the table name so all other automatically generated conditions would still work.</p>

<p>With this simple trick you can easily use models with views, stored procedures, or dynamically created queries like in my case!</p>

<p><link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc<em>embed</em>signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="//pawelniewiadomski.us1.list-manage.com/subscribe/post?u=30d4688f6cd649994b08f1974&amp;id=5759e18390" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <h2>Get my newsletter for software people</h2>
<div class="mc-field-group">
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required placeholder="Your e-mail (required)">
</div>
<div class="mc-field-group">
    <input type="text" value="" name="NAME" class="" id="mce-NAME" placeholder="Your first name">
</div>
    <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_30d4688f6cd649994b08f1974_5759e18390" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe!" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div></p>

  </article>

  <footer>
    <div class="links">
      <a href="https://pawelniewiadomski.com/newsletter">Want to get on my list?</a>
    </div>
  </footer>
</div>

  </body>
</html>
