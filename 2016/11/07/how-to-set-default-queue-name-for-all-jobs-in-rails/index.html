<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <meta property="og:title" content="How to set a default queue name for all jobs in Rails?">

<meta property="og:type" content="website">

<meta property="og:url" content="https://pawelniewiadomski.com/2016/11/07/how-to-set-default-queue-name-for-all-jobs-in-rails/">

<meta property="og:image" content="https://pawelniewiadomski.com/media/avatar.jpg">

<meta property="og:description" content="">

<meta property="og:site_name" content="Pawel Niewiadomski">

<meta property="og:locale" content="en_US">


  <meta property="article:published_time" content="2016-11-07T00:00:00+00:00">
  <meta property="article:author" content="http://facebook.com/pawelniewie">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2017/02/27/graphql-intro-to-queries-mutations-authorization/">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2017/02/20/pitfalls-of-ruby-memoization-pattern/">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2016/12/06/is-unless-in-ruby-really-a-shortcut/">
  


<meta property="fb:admins" content="http://facebook.com/pawelniewie">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1934760-4', 'auto');
  ga('send', 'pageview');
</script>
<script src="/public/jquery.scrolldepth.min.js"></script>
<script src="/public/screentime.min.js"></script>
<script src="/public/riveted.min.js"></script>
<script>
jQuery(function() {
  jQuery.scrollDepth();
  jQuery.screentime({
	  fields: [
	    { selector: '.masthead',
	      name: 'Master header'
	    },
	    { selector: '.container .post',
	      name: 'Post'
	    },
	    { selector: '.container .related',
	      name: 'Related'
	    }
	  ],
    googleAnalytics: true
	});
  riveted.init();
});
</script>
<script src="/public/hotjar.min.js"></script>
<script>
jQuery(function() {
	jQuery('#mce-NAME').on('change', function() {
		ga('send', 'event', 'Newsletter', 'Filled', 'First name');
	});

	jQuery('#mce-EMAIL').on('change', function() {
		ga('send', 'event', 'Newsletter', 'Filled', 'Email');
	});

	jQuery('#mc-embedded-subscribe').on('click', function() {
		ga('send', 'event', 'Newsletter', 'Clicked', 'Subscribe');
	});
});
</script>

  <title>
    
      How to set a default queue name for all jobs in Rails? &middot; Pawel Niewiadomski
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="canonical" href="https://pawelniewiadomski.com/2016/11/07/how-to-set-default-queue-name-for-all-jobs-in-rails/">
</head>


  <body>
    <div class="container content">
  <small class="back">
    <strong>‚Üê <a href="https://pawelniewiadomski.com">back home</a></strong>
  </small>

  <article class="post">
    <h1 class="post-title">How to set a default queue name for all jobs in Rails?</h1>
    
      <span class="post-date">07 Nov 2016</span>
    
    <p>I'm working on a gem for sharing <a href="http://github.com/pawelniewie/rails-commons">common Rails</a> code between my apps. I just added there a first job and hit a problem - the job from the gem was using <code>default</code> queue which doesn't exist. </p>

<p>Well I knew I will have this problem but I didn't expect that figuring out how to change the default name will take me so much time.</p>

<p>I use <a href="https://github.com/phstc/shoryuken">shoryuken</a> for running jobs, the configuration looks like this:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">aws</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">access_key_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;%= ENV["AWS_ACCESS_KEY_ID"] %&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">secret_access_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;%= ENV["AWS_SECRET_ACCESS_KEY"] %&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="s">"us-east-1"</span>
  <span class="l l-Scalar l-Scalar-Plain">receive_message</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">wait_time_seconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="l l-Scalar l-Scalar-Plain">concurrency</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="l l-Scalar l-Scalar-Plain">queues</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="s">'customer-feedback'</span>
  <span class="p p-Indicator">-</span> <span class="s">'customer-feedback-mailer'</span>
</code></pre></div>
<p>As you can see there's no <code>default</code> queue. It's not a problem as I can use <code>queue_as</code> in <code>ApplicationJob</code>. But the job from the gem cannot extend <code>ApplicationJob</code>. Also it must not have a hard coded name either.</p>

<p>I expected there should be a way in Rails to set the default queue name for all jobs and there is but it was really difficult to find it.</p>

<p>The documentation mentioned <code>config.active_job.default_queue_name</code> and looking at the code it should be picked up. But as I found out the default is picked up too early before the application can override it.</p>

<p><link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc<em>embed</em>signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
</p>
<div id="mc_embed_signup">
<form action="//pawelniewiadomski.us1.list-manage.com/subscribe/post?u=30d4688f6cd649994b08f1974&amp;id=5759e18390" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <h2>Get my newsletter for software people</h2>
<div class="mc-field-group">
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required placeholder="Your e-mail (required)">
</div>
<div class="mc-field-group">
    <input type="text" value="" name="NAME" class="" id="mce-NAME" placeholder="Your first name">
</div>
    <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_30d4688f6cd649994b08f1974_5759e18390" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe!" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<p>The most interesting code is in <code>ActiveJob::QueueName</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">included</span> <span class="k">do</span>
  <span class="n">class_attribute</span> <span class="ss">:queue_name</span><span class="p">,</span> <span class="ss">instance_accessor</span><span class="p">:</span> <span class="kp">false</span>
  <span class="n">class_attribute</span> <span class="ss">:queue_name_delimiter</span><span class="p">,</span> <span class="ss">instance_accessor</span><span class="p">:</span> <span class="kp">false</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="n">default_queue_name</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">queue_name_delimiter</span> <span class="o">=</span> <span class="s2">"_"</span> <span class="c1"># set default delimiter to '_'</span>
<span class="k">end</span>

<span class="c1"># Returns the name of the queue the job will be run on.</span>
<span class="k">def</span> <span class="nf">queue_name</span>
  <span class="k">if</span> <span class="vi">@queue_name</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Proc</span><span class="p">)</span>
    <span class="vi">@queue_name</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">queue_name_from_part</span><span class="p">(</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@queue_name</span><span class="p">))</span>
  <span class="k">end</span>
  <span class="vi">@queue_name</span>
<span class="k">end</span>
</code></pre></div>
<p>As you can see when included into <code>ActiveJob::Base</code> it will establish <code>queue_name</code> class attribute. You can check <code>class_attribute</code> documentation - it's a very interesting method - you can propagate value from a parent class to all sub classes, and allow subclasses to override the value. Propagation happens even after objects were created provided the subclass didn't override.</p>

<p>Playing with it I discovered you can use following code to override queue name:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">config</span><span class="o">.</span><span class="n">active_job</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="s1">'customer-feedback'</span>
</code></pre></div>
<p>That worked (almost), as there's no <code>customer-feedback</code> queue. I use prefixed queue names:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">config</span><span class="o">.</span><span class="n">active_job</span><span class="o">.</span><span class="n">queue_name_prefix</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
</code></pre></div>
<p>So the real name of the queue should be something like <code>development_customer-feedback</code>.</p>

<p>As you noticed above <code>queue_name</code> method will take the name as is when it's a string, but will calculate it when it's <code>Proc</code>, so simple change fixed this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">config</span><span class="o">.</span><span class="n">active_job</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="s1">'customer-feedback'</span> <span class="p">}</span>
</code></pre></div>
<p>Now all jobs can use a proper queue, even without an explicit <code>queue_as</code>.</p>

<p>PS </p>

<p>You can also set a queue name and other attributes when executing the job:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">VideoJob</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
  <span class="ss">queue</span><span class="p">:</span> <span class="ss">:some_queue</span><span class="p">,</span> 
  <span class="ss">wait</span><span class="p">:</span> <span class="mi">5</span><span class="o">.</span><span class="n">minutes</span>
<span class="p">)</span><span class="o">.</span><span class="n">perform_later</span><span class="p">(</span><span class="no">Video</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
</code></pre></div>
  </article>

  <footer>
    <div class="links">
      <a href="https://pawelniewiadomski.com/newsletter">Want to get on my list?</a>
    </div>
  </footer>
</div>

  </body>
</html>
