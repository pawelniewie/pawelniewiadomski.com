<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <meta property="og:title" content="How to generate non predicable alphanumerical ids in Rails?">

<meta property="og:type" content="website">

<meta property="og:url" content="https://pawelniewiadomski.com/2016/07/19/using-non-predictable-ids-in-rails/">

<meta property="og:image" content="https://pawelniewiadomski.com/media/avatar.jpg">

<meta property="og:description" content="">

<meta property="og:site_name" content="Pawel Niewiadomski">

<meta property="og:locale" content="en_US">


  <meta property="article:published_time" content="2016-07-19T00:00:00+00:00">
  <meta property="article:author" content="http://facebook.com/pawelniewie">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2014/04/11/many-of-you-probably-already-heard-about/">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2013/12/20/what-you-should-not-forget-when-hosting-database-in-the/">
  
    <meta property="og:see_also" content="https://pawelniewiadomski.com/2017/02/27/graphql-intro-to-queries-mutations-authorization/">
  


<meta property="fb:admins" content="http://facebook.com/pawelniewie">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1934760-4', 'auto');
  ga('send', 'pageview');
</script>
<script src="/public/jquery.scrolldepth.min.js"></script>
<script src="/public/screentime.min.js"></script>
<script src="/public/riveted.min.js"></script>
<script>
jQuery(function() {
  jQuery.scrollDepth();
  jQuery.screentime({
	  fields: [
	    { selector: '.masthead',
	      name: 'Master header'
	    },
	    { selector: '.container .post',
	      name: 'Post'
	    },
	    { selector: '.container .related',
	      name: 'Related'
	    }
	  ],
    googleAnalytics: true
	});
  riveted.init();
});
</script>
<script src="/public/hotjar.min.js"></script>
<script>
jQuery(function() {
	jQuery('#mce-NAME').on('change', function() {
		ga('send', 'event', 'Newsletter', 'Filled', 'First name');
	});

	jQuery('#mce-EMAIL').on('change', function() {
		ga('send', 'event', 'Newsletter', 'Filled', 'Email');
	});

	jQuery('#mc-embedded-subscribe').on('click', function() {
		ga('send', 'event', 'Newsletter', 'Clicked', 'Subscribe');
	});
});
</script>

  <title>
    
      How to generate non predicable alphanumerical ids in Rails? &middot; Pawel Niewiadomski
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="canonical" href="https://pawelniewiadomski.com/2016/07/19/using-non-predictable-ids-in-rails/">
</head>


  <body>
    <div class="container content">
  <small class="back">
    <strong>‚Üê <a href="https://pawelniewiadomski.com">back home</a></strong>
  </small>

  <article class="post">
    <h1 class="post-title">How to generate non predicable alphanumerical ids in Rails?</h1>
    
      <span class="post-date">19 Jul 2016</span>
    
    <p>In many applications you generate ids that are visible to customers or used in links. Rails by default uses sequential integers for that which is fine most of the time. Those are integers so they are fast, short and look good ;-)</p>

<p>But they have one disadvantage - if they are visible externally someone can learn a lot about your business. For example if you&#39;re running a shop someone can guess how many orders you process, or number of items you offer or clients you have. Probably you want to avoid that.</p>

<p>You can fix that easily by switching to UUIDs, this is something Rails makes it <a href="http://theworkaround.com/2015/06/12/using-uuids-in-rails.html">really easy to do</a>.</p>

<p>You can have nice, non guessable identifiers like those:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>id: 898f73bc-290c-4427-b75a-68f34464e188, title: The Raven
id: dd126f47-de45-4cbe-aa1c-8b052693498e, title: My Side of the Mountain
id: 479af9a8-c096-42e2-8a29-4a321cdd5f7c, title: The Giver
</code></pre></div>
<p>The only downside is that they are long and ugly, computers don&#39;t care but humans do. You probably don&#39;t want to show them to user.</p>

<p>Is there an alternative?</p>

<p>Yes, there is. As I need non-predictable, human readable ids in our application I made a research and here&#39;s a few gems that I found interesting.</p>

<h2>Hashids</h2>

<p>The first one that draw my attentions is a project called <a href="http://hashids.org">hashids</a>. It&#39;s a set of libraries implementing the same algorithm in many languages.</p>

<p>You can get a lib for Ruby, Python, Java, Swift, or whatever else you like :-)</p>

<p>There&#39;s <a href="https://github.com/akinomaeni/hashid-rails">hashid-rails</a> as well for simple integration with Rails.</p>

<p>Simply update <code>Gemfile</code> with</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">gem</span> <span class="s1">&#39;hashid-rails&#39;</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">&#39;akinomaeni/hashid-rails&#39;</span>
</code></pre></div>
<p>Create <code>config/initializers/hashids.rb</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">hashids</span> <span class="o">=</span> <span class="no">Hashids</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="no">Hashid</span><span class="o">::</span><span class="no">Rails</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">secret_key_base</span> <span class="c1"># some secret id</span>
  <span class="n">config</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># length of the generated ids</span>
<span class="k">end</span>
</code></pre></div>
<p>And update your model to return hashid instead of the sequential id (here&#39;s for JSON representation):</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">HashidExample</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
    <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="k">super</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">to_param</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>So let&#39;s see how this works:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-07-15T20:34:17.722Z&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;KpzRp6&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-07-15T20:34:17.722Z&quot;</span>
    <span class="p">},</span> 
    <span class="p">{</span>
        <span class="nt">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-07-15T20:48:15.876Z&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;XmXMp3&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;another&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-07-15T20:48:15.876Z&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<p>What&#39;s really nice about the library is that you can still refer objects by their old id. So there&#39;s an easy migration path.</p>

<p>I have mixed feelings about one things though &rarr; hashids are not stored, so once you want to change settings (for example make them longer) you will break existing ones. So think carefully how large your database can get.</p>

<p>Other than that I like the gem. You can also encode multiple ids into one (in case you have complex keys and associations that you want to link to).</p>

<h2>Uniqify</h2>

<p>An alternative solution is to add a unique token to each model and store it in the database. There&#39;s a simple solution for that as well - <a href="https://github.com/Openbay/uniquify">uniqify</a>.</p>

<p>To add it to your project, update <code>Gemfile</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">gem</span> <span class="s1">&#39;uniquify&#39;</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">&#39;Openbay/uniquify&#39;</span>
</code></pre></div>
<p>Prepare a migration:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">add_column</span> <span class="ss">:uniqify_examples</span><span class="p">,</span> <span class="ss">:token</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">add_index</span> <span class="ss">:uniqify_examples</span><span class="p">,</span> <span class="ss">:token</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</code></pre></div>
<p>In your model:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">UniqifyExample</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
    <span class="n">uniquify</span> <span class="ss">:token</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="mi">6</span>

    <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="k">super</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">}</span> <span class="c1"># to hide id from JSON representation</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>What nice about this library is that you can have multiple tokens in the same model (in case you want that):</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">uniquify</span> <span class="ss">:token</span><span class="p">,</span> <span class="ss">:another</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="mi">6</span>
</code></pre></div>
<p>You can specify length, and allowed characters. Token gets persisted so you can change to format as you go.</p>

<h2>random_unique_id</h2>

<p>There&#39;s another very similar gem called <a href="https://github.com/pupeno/random_unique_id">random_unique_id</a>. I tested it out but didn&#39;t like it.</p>

<p>There are two limitations - I doesn&#39;t work out of the box with model hierarchy introduced by Rails (all models subclassing <code>ApplicationRecord</code> by default). You need to change your model and extend <code>ActiveRecord::Base</code>.</p>

<p>Also you can only have one unique field per model which is fine most of the time. But we are going to use multiple tokens for some models.</p>

<h2>Or just use math (update 2016-07-19)</h2>

<p><a href="https://github.com/kikonen">Kari Ikonen</a> was so kind to mention that there is another way - mathematical one!</p>

<p>You can use multiplicative inverses to create obfuscated integers.</p>

<p>It&#39;s really cheap and easy to do, and you can read more about it at <a href="https://ericlippert.com/2013/11/14/a-practical-use-of-multiplicative-inverses/">Eric Lippert&#39;s blog</a>.</p>

<h2>How long should be the token?</h2>

<p>That Depends on the character set that you will use. Generally all libraries use something like 62 possibilities for each character:</p>

<p><code>0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz</code></p>

<blockquote>
<p>5 chars in base 62 will give you 62^5 unique IDs = 916,132,832 (~1 billion) At 10k IDs per day you will be ok for 91k+ days</p>

<p>6 chars in base 62 will give you 62^6 unique IDs = 56,800,235,584 (56+ billion) At 10k IDs per day you will be ok for 5+ million days</p>

<p>-- from <a href="http://stackoverflow.com/a/9543797">StackOverflow</a></p>
</blockquote>

<h2>Other approaches?</h2>

<p><a href="http://instagram-engineering.tumblr.com/post/10853187575/sharding-ids-at-instagram">Instagram come up with an interesting approach</a> that helps them generate unique ids and at the same time shard data. If you&#39;re going to be huge like them it&#39;s worth considering. I&#39;d love to have problems like that ;-)</p>

<h2>Final thoughts</h2>

<p>I think <code>uniqify</code> and <code>hashids</code> are both two interesting gems you can try to use. I&#39;m not sure yet which one we&#39;re going to choose. Will update the article once we have a decision.</p>

<p>I also prepared <a href="https://github.com/pawelniewie/non-predictable-ids">a small project</a> you can play with. Run:</p>

<p><code>bundle install</code></p>

<p><code>rails s</code></p>

<p><code>brew install httpie</code></p>

<p>Then you can play with it:</p>

<p><code>http http://localhost:3000/hashids title=test</code></p>

<p><code>http http://localhost:3000/hashids</code></p>

<p><code>http http://localhost:3000/hashids/1</code></p>

<p><code>http http://localhost:3000/rids title=another</code></p>

<p><code>http http://localhost:3000/rids</code></p>

<p><code>http http://localhost:3000/uniqifies title=hurra</code></p>

<p><code>http http://localhost:3000/uniqifies</code></p>

  </article>

  <footer>
    <div class="links">
      <a href="https://pawelniewiadomski.com/newsletter">Want to get on my list?</a>
    </div>
  </footer>
</div>

  </body>
</html>
